<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>质押服务申请</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
		<link rel="stylesheet" href="lib/all.css" />
		<link rel="stylesheet" href="lib/css.css" />
		<style>
			body{
				background: #f3f5fe;
				font-size: 0.24rem;
			}		
			header{
				width: 100%;
				height: 0.68rem;
				line-height: 0.68rem;
				padding-left: 0.36rem;
				font-size: 0.2rem;
			}	
			.addr-choose-in select{
				width: 32%;
				height: 0.68rem;
				outline: none;
				border: none;
				background: #F3F5FE;
				border-radius: 0.08rem;
				font-size: 0.2rem;
				color: #CDCCCD;
			}
			.otherpromise{
				margin-top: 0.2rem;
			}
			.otherpromise-in input{
				width: 90%;
				outline: none;
				border: none;
			}	
			.deal{
				text-align: center;
				height: 1.32rem;
				line-height: 1.32rem;
				margin-top: 0.7rem;
			}
			.deal>span:first-of-type{
				display: inline-block;
				width: 0.44rem;
				height: 0.44rem;
				background-size: 0.44rem 0.44rem;
				margin-right: 0.25rem;
			}
			.dealno{
				background: url(images/3.png) no-repeat center center;
				
			}
			.dealyes{
				background: url(images/1.png) no-repeat center center;
			}
			.deal>span{
				vertical-align: middle;
				font-size: 0.18rem;
			}
			.deal>a{
				vertical-align: middle;
				font-size: 0.18rem;
				color: #03dcc5;
			}		
		</style>
		<script src="lib/common.js"></script>
		<script type="text/javascript" src="lib/selfFit.js" ></script>
		<script type="text/javascript" src="lib/jquery-2.2.4.min.js" ></script>
		<script type="text/javascript" src="lib/distpicker.js" ></script>
		<script src="lib/common.js"></script>
	</head>
	<body>

           <!--成功窗口-->
        <div id="result-success"> 
			<div class="result-bg"></div>
			<div class="result-show">
			     <div>
			     	<img src="images/4.png" id="result-pic" />
			     </div>
			     <div>
			     	<!--<p id="result-fail">失败原因——申请提交失败！</p>-->
			     	<p id="result-in">申请已提交！</p>
			     </div>
			</div>
		</div>

		 <!--失败窗口-->
        <div id="result-error"> 
			<div class="result-bg"></div>
			<div class="result-showfail">
			     <div>
			     	<img src="images/5.png" id="result-pic" />
			     </div>
			     <div>
			     	<p id="result-in">失败原因——申请提交失败！</p>
			     </div>
			</div>
		</div>

		<header>注：以下商品单价及总金额为含税17%。</header>
	    <div class="addr cell">
			<div class="addr-choose">
				<div>意向交货地址</div>
				<div class="addr-choose-in">
					<div data-toggle="distpicker">
					  <select data-province="省"></select>
					  <select data-city="市"></select>
					  <select data-district="区"></select>
					</div>
				</div>
			</div>
			<div class="addr-warehouse">
				<div>交货仓库</div>
				<div class="addr-warehouse-in">
					<select id="cells">
						<option>请选择交货仓库</option>
					</select>
				</div>
			</div>
		</div>
		<div class="goods">
			<div class="goods-model" style="display: none;">
				<div class="goods-box cell">
					<div class="goods-info">
						<div>质押商品</div>
						<div class="goods-info-select">
							<div class="goods-info-select-type">
								<select id = "productType">
									<option>商品类型</option>
								</select>
							</div>
							<div class="goods-info-select-name">
								<select  id="productNames">
									<option>商品名称</option>
								</select>
							</div>
						</div>
					</div>
					
					<div class="goods-price">
						<div>意向单价</div>
						<div class="goods-price-in goodsin">
							<div>
								<input type="text"  onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/>
							</div>
							<div>元/每吨</div>
						</div>
					</div>
					<div class="goods-weight">
						<div>重量</div>
						<div class="goods-weight-in goodsin">
							<div>
								<input type="text" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/>
							</div>
							<div>顿</div>
						</div>
					</div>
					<div class="goods-num">
						<div>件数</div>
						<div class="goods-num-in goodsin">
							<div>
								<input type="text" onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')"/>
							</div>
							<div>$</div>
						</div>
					</div>
					<div class="goods-delete">删除此商品</div>
				</div>
			</div>

			<div class="good-wrap">
				<div class="goods-box cell">
					<div class="goods-info">
						<div>质押商品</div>
						<div class="goods-info-select">
							<div class="goods-info-select-type">
								<select id="productTypeFirst">
									<option >商品类型</option>
								</select>
							</div>
							<div class="goods-info-select-name">
								<select id="productNamesFirst">
									<option>商品名称</option>
								</select>
							</div>
						</div>
					</div>
					
					<div class="goods-price">
						<div>意向单价</div>
						<div class="goods-price-in goodsin">
							<div>
								<input type="text"  onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/>
							</div>
							<div>元/每吨</div>
						</div>
					</div>
					<div class="goods-weight">
						<div>重量</div>
						<div class="goods-weight-in goodsin">
							<div>
								<input type="text" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/>
							</div>
							<div>顿</div>
						</div>
					</div>
					<div class="goods-num">
						<div>件数</div>
						<div class="goods-num-in goodsin">
							<div>
								<input type="text" onkeyup="if(isNaN(value))execCommand('undo')" onafterpaste="if(isNaN(value))execCommand('undo')"/>
							</div>
							<div>$</div>
						</div>
					</div>
				</div>
			</div>
			<div class="goods-add">
				+添加更多商品
			</div>
		</div>
		<div class="otherpromise cell">
			<div>
				<div>其他约定</div>
				<div class="otherpromise-in">
					<input type="text" />
				</div>
			</div>
			
		</div>
		<div class="deal">
			<span class="dealno"></span><span>已同意</span><a href="contractZSZY.html">《中实质押合同》</a>
		</div>
	    <div class="submit" id="submit">提交</div>
		
		<script>
			var add = $('.goods-add'),
			    foodWrap = $('.good-wrap'),
			    box = $('.goods-box'),
			    theDeal = $('.deal>span').eq(0);
			    submitBtn = $('#submit'); 
			    productTypeFirstBtn = $('#productTypeFirst');
			    mtn = theCommonFn.getMtn();
			    
         //添加list同时绑定select元素用以监听
 			add.click(function(){
				var theModel = $('.goods-model').children().clone();
				theModel.appendTo(foodWrap);
                $("select").change(function() {
                	var firstSelect=$(this);  //产品类型选择框
                	var productTypeId = $(this).find("option:checked").attr("data-id");
                	var secondSelect=firstSelect.parent().siblings().children(); //产品名字选择框
                     //alert("zhelishejizhongyao");
                     getProductNameListNext(secondSelect,productTypeId);
                    console.log("当前窗口为："+ $(this).find("option:checked").attr("data-id"));
                     //console.log("测试窗口为："+ $(this).parent().siblings().children());
                     // $(this).parent().siblings().children().find("option:checked").append('<option data-id="'+4+'" >'+'飞机4'+'</option>');
                     //secondSelect.append('<option data-id="'+4+'" >'+'飞机5'+'</option>');
                    // $('#productNames').append('<option data-id="'+3+'" >'+'飞机3'+'</option>');  //首行插入
                 //$(this).find("option:checked").append('<option data-id="'+4+'" >'+'飞机4'+'</option>');
                 //console.log( $(this).next());
                 // console.log( "这里是：" + $(this).find("option:checked").attr("data-id"));
                 // console.log( $('#productNamesFirst').next());
            });

			});
			foodWrap.on('click','.goods-delete',function(){
				$(this).parent().remove();
			});
			theDeal.click(function(){
				if($(this).hasClass('dealno')){
					$(this).removeClass('dealno').addClass('dealyes');
				}else{
					$(this).removeClass('dealyes').addClass('dealno');
				}
			});

//获取存储仓库列表
			$.ajax({
				type:"post",
				url:"https://wei.wiyarn.com/actiz/rs/b?_s=coop&_m=listStorageHosue",
				async:true,
				data:{
					loginId: 'ufuy4bfc6i',
					mtn: mtn,
					fromType:2,
					mobile:true,
					_m:'listStorageHosue',
					_s:'coop',
					buildID:201608071700,
					loc:'zh-Hans',
					versionID:'1.0.0'
				},
				beforeSend:function(){
				},
				success:function(rep){
					var reps;
					try{
						reps = JSON.parse(rep);		
					}catch(e){
						//TODO handle the exception
					};
					if(reps.result){
						var str = '',
						    list = reps.content;
						for(var i=0;i<list.length;i++){
							str += '<option data-id="'+list[i].storeHouseId +'" >'+list[i].storeHouseName+'</option>'
						};
						$('#cells').append(str);
					}
				},
				error:function(){
					theCommonFn.alertWin('服务器出错')
				}
			});

//商品类型信息列表
			$.ajax({
				type:"post",
				url:"https://wei.wiyarn.com/actiz/rs/b?_s=coop&_m=listProductType2Zy",
				async:true,
				data:{
					loginId: 'ufuy4bfc6i',
					mtn: 'e0ec76abc1575149dba5ba35cfcc8411',
					fromType:2,
					mobile:true,
					_m:'listProductType2Zy',
					_s:'coop',
					buildID:201608071700,
					loc:'zh-Hans',
					versionID:'1.0.0'
				},
				beforeSend:function(){
				},
				success:function(rep){
					var reps;
					try{
						reps = JSON.parse(rep);	
						//console.log(rep);	
					}catch(e){
						//TODO handle the exception
					};
					if(reps.result){
						var str = '',
						    list = reps.content;
						for(var i=0;i<list.length;i++){
							str += '<option data-id="'+list[i].product_type_id +'" >'+list[i].product_type_name+'</option>'
						};
						$('#productTypeFirst').append(str);  //首行插入
						$('#productType').append(str);       //除了首行之外的其余行插入
					}
				},
				error:function(){
					theCommonFn.alertWin('服务器出错')
				}
			});


           // $("select").change(function() {
           //       alert($(this).find("option:checked").attr("data-id"));
           //       getProductNameList();
           //       // $('#productNamesFirst').append('<option data-id="'+3+'" >'+'飞机3'+'</option>');  //首行插入
           //       // $(this).find("option:checked").append('<option data-id="'+4+'" >'+'飞机4'+'</option>');
           //       //console.log( $(this).next());
           //       console.log( "这里是：" + $(this).find("option:checked").attr("data-id"));
           //       console.log( $('#productNamesFirst').next());
           //  });

          //首框展示
          $("#productTypeFirst").change(function() {
                 getProductNameList();
            });


           function getProductNameList(){
                 $.ajax({
				type:"post",
				url:"https://wei.wiyarn.com/actiz/rs/b?_s=coop&_m=listProductByTypeId",
				async:true,
				data:{
					loginId: 'ufuy4bfc6i',
					mtn: 'e0ec76abc1575149dba5ba35cfcc8411',
					fromType:2,
					mobile:true,
					_m:'listProductByTypeId',
					_s:'coop',
					buildID:201608071700,
					loc:'zh-Hans',
					versionID:'1.0.0',
					supplier_id:'10',
					productTypeId:'1'

				},
				beforeSend:function(){
				},
				success:function(rep){
					var reps;
					try{
						reps = JSON.parse(rep);	
						//console.log(rep);	
					}catch(e){
						//TODO handle the exception
					};
					if(reps.result){
						var str = '',
						    list = reps.content;
						for(var i=0;i<list.length;i++){
							str += '<option data-id="'+list[i].product_id +'" >'+list[i].product_name+'</option>'
						};
                             //str = '<option data-id="'+2+'" >'+'傻子'+'</option>';
						//$('#productNamesFirst').append('<option data-id="'+2+'" >'+'飞机'+'</option>');  //首行插入
						$('#productNamesFirst').append(str);  //首行插入
						//$('#productNames').append(str);       //除了首行之外的其余行插入
					}
				},
				error:function(){
					theCommonFn.alertWin('服务器出错')
				}
			});
           }

 function getProductNameListNext(secondSelect,productTypeId){
 	             var secondSelectObject = secondSelect;
 	             var productTypeIdResult = productTypeId;
                 $.ajax({
				type:"post",
				url:"https://wei.wiyarn.com/actiz/rs/b?_s=coop&_m=listProductByTypeId",
				async:true,
				data:{
					loginId: 'ufuy4bfc6i',
					mtn: 'e0ec76abc1575149dba5ba35cfcc8411',
					fromType:2,
					mobile:true,
					_m:'listProductByTypeId',
					_s:'coop',
					buildID:201608071700,
					loc:'zh-Hans',
					versionID:'1.0.0',
					supplier_id:'10',
					productTypeId:productTypeIdResult

				},
				beforeSend:function(){
				},
				success:function(rep){
					var reps;
					try{
						reps = JSON.parse(rep);	
						//console.log(rep);	
					}catch(e){
						//TODO handle the exception
					};
					if(reps.result){
						var str = '',
						    list = reps.content;
						for(var i=0;i<list.length;i++){
							str += '<option data-id="'+list[i].product_id +'" >'+list[i].product_name+'</option>'
						};
                        secondSelectObject.append(str);
						//$('#productNames').append(str);  
					}
				},
				error:function(){
					theCommonFn.alertWin('服务器出错')
				}
			});
           }

			submitBtn.click(function(){
                var isError = 0 ;
				if($('#cells').val()=='请选择交货仓库'){
					theCommonFn.alertWin('请选择交货仓库');
					return;
				}else{
					$('.good-wrap').find('input').each(function(i,item){
						if(!$(this).val()){
							theCommonFn.alertWin('请填写完整');
							isError = 1;
							return;
						}
					})
				};

	            if(theDeal.hasClass('dealno')){
							theCommonFn.alertWin('您未同意储存协议');
							return;
				}
									
                if(isError == '1'){
                	return;
                }

                var product=[],theData;
                for(var i=0;i<$('.good-wrap').find('.goods-box').length;i++){
                	var info = $('.good-wrap').find('.goods-box').eq(i);
                	var wareHouse  = $('.addr').find('.addr-warehouse').eq(i);
                	product.push({
                		"product_classify_id	":$.trim(info.find('.goods-info-select-type select').find("option:checked").attr("data-id")),
		                "productTypeName":$.trim(info.find('.goods-info-select-type select').val()),
		                "storeHouseId":$.trim(wareHouse.find('.addr-warehouse-in select').val()),
		                "productid": $.trim(info.find('.goods-info-select-name select').find("option:checked").attr("data-id")),
		                "productname":$.trim(info.find('.goods-info-select-name select').val()),
		                "productnum":"商品编码",
		                "weight":$.trim(info.find('.goods-weight-in input').val()),
		                "unitprice	":$.trim(info.find('.goods-price-in input').val()),   //goods-price-in
		                "itemNumber":$.trim(info.find('.goods-num input').val()), //goods-num
		                "money":"商品总价"
                		})
                   
                }
                console.log(product);
				$("#result-success").show();
				theCommonFn.waitAndClosePrompts('1','3000');
			});
		</script>
	</body>
</html>
